name: ğŸš€ SwedPrime SaaS - CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '22'
  FIREBASE_PROJECT_ID: 'your-firebase-project-id'

jobs:
  # Test and lint job
  test:
    name: ğŸ§ª Test & Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'webapp/package-lock.json'

      - name: ğŸ“¦ Install webapp dependencies
        working-directory: webapp
        run: npm ci

      - name: ğŸ” Lint webapp
        working-directory: webapp
        run: npm run lint

      - name: ğŸ“¦ Install functions dependencies
        working-directory: functions
        run: npm ci

      - name: ğŸ” Lint functions
        working-directory: functions
        run: npm run lint

      - name: ğŸ§ª Run tests (if any)
        working-directory: webapp
        run: |
          if [ -f package.json ] && npm run | grep -q "test"; then
            npm run test
          else
            echo "No tests found, skipping..."
          fi

  # Build job
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'webapp/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        working-directory: webapp
        run: npm ci

      - name: ğŸ—ï¸ Build application
        working-directory: webapp
        env:
          # Add your production environment variables here
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
        run: npm run build

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-files
          path: webapp/dist/
          retention-days: 1

  # Deploy to staging (develop branch)
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-files
          path: webapp/dist/

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Firebase CLI
        run: npm install -g firebase-tools

      - name: ğŸš€ Deploy to Firebase Staging
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_DEPLOY_TOKEN }}
        run: |
          firebase use staging --token $FIREBASE_TOKEN
          firebase deploy --only hosting --token $FIREBASE_TOKEN
          echo "ğŸ‰ Staging deployment complete!"

  # Deploy to production (main branch)
  deploy-production:
    name: ğŸ¯ Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-files
          path: webapp/dist/

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Firebase CLI
        run: npm install -g firebase-tools

      - name: ğŸ“¦ Install Functions dependencies (for deployment)
        working-directory: functions
        run: npm ci --only=production

      - name: ğŸš€ Deploy to Firebase Production
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_DEPLOY_TOKEN }}
        run: |
          firebase use production --token $FIREBASE_TOKEN
          firebase deploy --token $FIREBASE_TOKEN
          echo "ğŸ‰ Production deployment complete!"

      - name: ğŸ¥ Health Check
        run: |
          sleep 30
          response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.FIREBASE_PROJECT_ID }}.web.app/api/health)
          if [ $response -eq 200 ]; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed with status: $response"
            exit 1
          fi

      - name: ğŸ”” Notify deployment success
        if: success()
        run: |
          echo "ğŸ‰ SwedPrime SaaS deployed successfully to production!"
          echo "ğŸŒ Live URL: https://${{ env.FIREBASE_PROJECT_ID }}.web.app"
          echo "ğŸ“Š Admin: https://${{ env.FIREBASE_PROJECT_ID }}.web.app/admin/demo-company"
          echo "ğŸ’³ Pricing: https://${{ env.FIREBASE_PROJECT_ID }}.web.app/pricing"

      - name: ğŸš¨ Notify deployment failure
        if: failure()
        run: |
          echo "âŒ SwedPrime SaaS deployment failed!"
          echo "Check the logs above for details."
          exit 1

  # Security audit job
  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”’ Run security audit (webapp)
        working-directory: webapp
        run: |
          npm audit --audit-level moderate
          
      - name: ğŸ”’ Run security audit (functions)
        working-directory: functions
        run: |
          npm audit --audit-level moderate 